---
title: "Needs Assessment Report" 
author: "Timothy Keyes" 
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, dpi = 250)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(lubridate)
library(likert)

# Parameters
input_path <- here::here("data", "mspa_na_data.rds")
metadata_path <- here::here("data-raw", "school_metadata.csv")

total_md <- 153
total_do <- 36

likert_colors <- c("darkgreen","green","orange","red","darkred")

likert_labels <- 
  c(
    "Strongly disagree",
    "Somewhat disagree", 
    "Neither agree nor disagree", 
    "Somewhat agree", 
    "Strongly agree"
  )

my_theme <- 
  theme(
    axis.text.y = element_text(size = 9),
    axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
    axis.title.y = element_text(size = 12, face = "bold"), 
    axis.title.x = element_text(size = 12, face = "bold")
  ) 

#===============================================================================

# read in data
na_data <- 
  input_path %>% 
  read_rds()

metadata <- 
  metadata_path %>% 
  read_csv() %>% 
  drop_na()
```

## Broad data and recruitment summary

First, we want to see if we were able to obtain consent from everyone who took the survey: 

```{r}
na_data %>% 
  count(consent)
```

Thus, we can see that there are 32 people who didn't actually check the "consent" box. They will need to be removed from the analysis. 

We can also look, for our own purposes, of the number of responses over the time window that the survey was open. 

```{r}
na_data %>% 
  count(date = lubridate::as_date(timestamp), name = "responses") %>% 
  ggplot(aes(x = date, y = responses)) + 
  geom_line() + 
  scale_x_date(
    breaks = scales::breaks_width(width = "2 months"), 
    labels = scales::label_date(format = "%b %Y")
  ) + 
  labs(
    title = "Number of responses to the N-A survey by date", 
    x = NULL, 
    y = "Responses (# of students per day)"
  )

```

From this, we can see that recruitment tends to happen in a punctuated fashion rather than by trickle-in over time. Each of the peaks corresponds to pushes coordinated by our team to send the survey to additional schools.

For a cumulative plot...

```{r, warning = FALSE}
num_students <- function(date) { 
  na_data %>% 
    mutate(my_date = as_date(timestamp)) %>% 
    filter(my_date <= date) %>% 
    count() %>% 
    pull(n)
}

na_data %>% 
  transmute(
    my_date = as_date(timestamp), 
    unique_students = 
      map_int(my_date, num_students)
  ) %>% 
  ggplot(aes(x = my_date, y = unique_students)) + 
  geom_line() + 
  scale_x_date(
    breaks = scales::breaks_width(width = "2 months"), 
    labels = scales::label_date(format = "%b %Y")
  ) + 
  labs(
    title = "Respondent recruitment over time", 
    x = NULL, 
    y = "Number of unique students"
  )

```


We can also look at our recruitment of unique schools over time: 

```{r, warning=FALSE}
num_schools <- function(date) { 
  na_data %>% 
    mutate(my_date = as_date(timestamp)) %>% 
    filter(my_date <= date) %>% 
    pull(school_attend) %>% 
    n_distinct()
}


na_data %>% 
  transmute(
    my_date = as_date(timestamp), 
    unique_schools = 
      map_int(my_date, num_schools)
  ) %>% 
  ggplot(aes(x = my_date, y = unique_schools)) + 
  geom_line() + 
  scale_x_date(
    breaks = scales::breaks_width(width = "2 months"), 
    labels = scales::label_date(format = "%b %Y")
  ) + 
  labs(
    title = "School recruitment over time", 
    x = NULL, 
    y = "Number of unique schools recruited"
  )

```

Together, these plots indicate that, in general, having a survey link passively open over time does not really lead to the steady "trickling in" of responses over time. Rather, it seems that coordinated pushes of survey instruments to specific schools (with wide desemination) yield the most responses, Thus, one strategic recommendation for MSPA might be to build its survey instrument distribution infrastructure (either through a portal, an app that MSPA members can have on their phones, or some other architecture that leverages our campus network). 

## Wrangling

I've already done some data cleaning in previous scripts, but there are still a few tweaks that we probably want to make so that everything is human-readable and so that only useful information is carried forward. 

First, we want to remove people who did not consent to the survey, since we can't use their information anyway. 

```{r}
na_data <- 
  na_data %>% 
  filter(consent == "yes")
```

And then we can filter out some variables that we don't need.

```{r}
na_data <- 
  na_data %>% 
  select(-survey_id, -consent, -complete)
```

And create a few variables that we'll need later: 

```{r}
na_data <- 
  na_data %>% 
  mutate(
    sex = 
      case_when(
        sab_is_male == "yes"   ~ "male", 
        sab_is_female == "yes" ~ "female", 
        TRUE                   ~ NA_character_
      )
  ) %>% 
  left_join(metadata, by = c("school_attend" = "name"))
```


## Univariate Demographics report

The first section of the survey asked questions about respondents' demographic identifiers, including the following: 

* What school they attend 
* What year of medical school they're in
* Whether or not they identify as LGBTQ+
* What sex they were assigned at birth 
* What their current gender identity is
* What they current sexual orientation is
* Their race/ethnicity

Below, we report the breakdown of our survey respondents by each of these demographics.

### What school do you attend?

Schools are arranged in order of decreasing number of responses. 

```{r}
na_data %>%
  count(school_attend, name = "Number of responses") %>% 
  mutate(
    `Percentage of total responses` = 
      ((`Number of responses` / sum(`Number of responses`)) * 100) %>% 
      round(digits = 1)
  ) %>% 
  rename(School = school_attend) %>% 
  arrange(desc(`Number of responses`)) %>% 
  knitr::kable()
```

### What year of medical school are you in? 

```{r, fig.width = 6}
n <- 
  na_data %>% 
  filter(!is.na(med_school_year)) %>% 
  count() %>% 
  pull(n)

na_data %>% 
  drop_na(med_school_year) %>% 
  mutate(
    med_school_year = fct_infreq(med_school_year %>% str_wrap(width = 25))
  ) %>% 
  ggplot(aes(x = med_school_year)) + 
  geom_bar() + 
  my_theme + 
  labs(
    x = NULL, 
    y = "Number of students", 
    caption = str_glue("N = ", {n})
  )
```


### Do you identify as LGBTQ+?

```{r}
n <- 
  na_data %>% 
  filter(!is.na(is_lgbtq)) %>% 
  count() %>% 
  pull(n)

na_data %>% 
  drop_na(is_lgbtq) %>% 
  ggplot(aes(x = is_lgbtq)) + 
  geom_bar() + 
  labs(
    x = NULL, 
    y = "Number of respondents", 
    caption = str_glue("N = {n}")
  )
```

### What is your sex assigned at birth?

```{r}
n <- 
  na_data %>% 
  filter(!is.na(sex)) %>% 
  count() %>% 
  pull(n)

na_data %>% 
  drop_na(sex) %>% 
  ggplot(aes(x = sex)) + 
  geom_bar() + 
  theme(
    axis.text = element_text(size = 12), 
    axis.title = element_text(size = 16)
  ) + 
  labs(
    x = NULL, 
    y = "Number of students", 
    caption = str_glue("N = {n}")
  )
  
```

### What is your gender identity?

```{r}
n <- 
  na_data %>% 
  filter_at(
    .vars = vars(starts_with("gender_")), 
    .vars_predicate = any_vars(!is.na(.))
  ) %>% 
  count() %>% 
  pull(n)

na_data %>% 
  summarize_at(
    .vars = vars(starts_with("gender")), 
    ~ sum(. == "yes")
  ) %>% 
  select(-gender_another_description) %>% 
  pivot_longer(
    cols = everything(), 
    names_to = "gender", 
    values_to = "Number of respondents", 
    names_prefix = "gender_"
  ) %>% 
  mutate(
    gender = fct_reorder(gender, desc(`Number of respondents`)), 
    percentage = (`Number of respondents` / sum(`Number of respondents`)) * 100
  ) %>% 
  ggplot(aes(x = gender, y = `Number of respondents`)) + 
  geom_col() + 
  geom_text(
    aes(
      y = `Number of respondents` + 15, 
      label = str_c(percentage %>% round(digits = 1), "%")
    )
  ) + 
  labs(
    x = NULL, 
    caption = str_glue("N = {n}")
  )
```

### What is your sexual orientation?

```{r}
n <- 
  na_data %>% 
  filter_at(
    .vars = vars(starts_with("so_")), 
    .vars_predicate = any_vars(!is.na(.))
  ) %>% 
  count() %>% 
  pull(n)

na_data %>% 
  summarize_at(
    .vars = vars(starts_with("so_")), 
    ~ sum(. == "yes")
  ) %>% 
  select(-so_another_description) %>% 
  pivot_longer(
    cols = everything(), 
    names_to = "sexual_orientation", 
    values_to = "Number of respondents", 
    names_prefix = "so_"
  ) %>% 
  mutate(
    sexual_orientation = fct_reorder(sexual_orientation, desc(`Number of respondents`)), 
    percentage = (`Number of respondents` / sum(`Number of respondents`)) * 100
  ) %>% 
  ggplot(aes(x = sexual_orientation, y = `Number of respondents`)) + 
  geom_col() + 
  geom_text(
    aes(
      y = `Number of respondents` + 15, 
      label = str_c(percentage %>% round(digits = 1), "%")
    )
  ) + 
  labs(
    x = NULL, 
    caption = str_glue("N = {n}")
  )
```

### What is your racial/ethnic background?

```{r}
n <- 
  na_data %>% 
  filter_at(
    .vars = vars(starts_with("race_")), 
    .vars_predicate = any_vars(!is.na(.))
  ) %>% 
  count() %>% 
  pull(n)

na_data %>% 
  summarize_at(
    .vars = vars(starts_with("race_")), 
    ~ sum(. == "yes")
  ) %>% 
  select(-race_another_explanation) %>% 
  pivot_longer(
    cols = everything(), 
    names_to = "race", 
    values_to = "Number of respondents", 
    names_prefix = "race_"
  ) %>% 
  mutate(
    race = fct_reorder(race, desc(`Number of respondents`)), 
    percentage = (`Number of respondents` / sum(`Number of respondents`)) * 100
  ) %>% 
  ggplot(aes(x = race, y = `Number of respondents`)) + 
  geom_col() + 
  geom_text(
    aes(
      y = `Number of respondents` + 15, 
      label = str_c(percentage %>% round(digits = 1), "%")
    )
  ) + 
  scale_x_discrete(
    labels = 
      c("White", "Asian", "Hispanic", 
        "Black", "Another", "Native", 
        "Pacific Islander")
  ) + 
  labs(
    x = NULL, 
    caption = str_glue("N = {n}")
  )
```

So we can see that most of the respondents are white, a group that accounts for about 2/3 of the total responses. There are a smaller percentage of Asian, Hispanic, and Black respondents, with Native, Pacific Islander, and "Other" groups corresponding to around 1% of the responses, each. 

### Program type

With merged data about the school that each student attends, we can also compare the number of MD and the number of DO students who responded to the survey: 

```{r}
n <- 
  na_data %>% 
  filter(!is.na(Degree)) %>% 
  count() %>%
  pull(n)

na_data %>% 
  drop_na(Degree) %>% 
  count(Degree, name = "Number of respondents") %>% 
  mutate(
    Degree = fct_reorder(Degree, desc(`Number of respondents`)), 
    percentage = (`Number of respondents` / sum(`Number of respondents`)) * 100
  ) %>% 
  ggplot(aes(x = Degree, y = `Number of respondents`)) + 
  geom_col() + 
  geom_text(
    aes(
      y = `Number of respondents` + 20, 
      label = str_c(percentage %>% round(digits = 1), "%")
    )
  ) + 
  labs(
    title = "Number of responses from MD- and DO-granting programs", 
    x = NULL, 
    caption = str_glue("N = {n}")
  )
```

Thus, we can see that the number of DO student responses is relatively small relative to the number of MD students.

## Number of unique medical schools

According to the Association of American Medical Colleges, there are [153 accredited MD-granting programs in the United States](https://www.aamc.org/data-reports/students-residents/interactive-data/2019-facts-applicants-and-matriculants-data); likewise, the American Association of Colleges of Osteopathic Medicine (AACOM) [accredits 36 DO-granting programs](https://www.aacom.org/become-a-doctor/u-s-colleges-of-osteopathic-medicine) in the United States.

So, we can compute the number of unique MD and unique DO schools (as well as their percentage of the national numbers). 

```{r}
totals <- tibble(Degree = c("DO", "MD"), total = c(total_do, total_md))

na_data %>% 
  select(school_attend, Degree) %>%
  drop_na() %>% 
  distinct() %>%
  count(Degree) %>% 
  left_join(totals, by = "Degree") %>% 
  mutate(proportion = n / total) %>% 
  knitr::kable()

```

So, we can see that we have 100 MD schools (65% of total schools), and 18 DO schools (50% of total).

However, we remember from our response plots above that most of the schools from which we have responses only have a few (<5) students who responded...this is a problem we will either have to solve or something that we will have to wordsmith around. 

## Do medical students think MSPA is a good idea? 

In the second section of the needs-assessment survey, we asked questions about intercollegiate LGBTQ+ affinity group engagement and whether or not students felt that a national LGBTQ+ affinity organization would enhance their school's LGBTQ+ diversity/inclusion climate. 

Here's a generally useful function for plotting likert scale data that we'll use throughout this section: 

```{r}
## description: plots a stacked bar plot between LGBTQ+ and non-LGBTQ+ individuals when the likert scale is 
##              encoded by the variable my_var. Will provide the plot with the title `title` and the caption 
##              N = `n`. 
likert_plot <- function(my_var = NULL, title = NULL, n = NULL) { 
  na_data %>% 
    drop_na({{my_var}}, is_lgbtq) %>% 
    group_by(is_lgbtq, {{my_var}}) %>% 
    summarize(number = n()) %>% 
    mutate(proportion = number / sum(number)) %>% 
    ggplot(
      aes(
        x = is_lgbtq, 
        y = proportion, 
        fill = factor({{my_var}}, levels = as.character(5:1))
      )
    ) + 
    geom_hline(yintercept = 0.5, color = "black") + 
    geom_col() + 
    scale_y_continuous(labels = scales::label_percent(accuracy = 1)) + 
    scale_fill_brewer(
      labels = rev(likert_labels), 
      type = "div",
      palette = "RdYlGn", 
      aesthetics = "fill", 
      direction = -1, 
      guide = guide_legend(reverse = TRUE)
    ) + 
    coord_flip() + 
    theme(
      legend.title = element_text(size = 9),
      aspect.ratio = 0.4, 
      legend.position = "bottom"
    ) +  
    labs(
      subtitle = title,
      x = NULL,
      y = "Percentage of respondents", 
      fill = NULL,
      caption = str_glue("N = {n}")
    )
}
```



### Intercollegiate engagement of LGBTQ+ affinity organizations

**By individual - each person is a point**
```{r, fig.width=8}
#agree
n <- 
  na_data %>% 
  drop_na(interaction_agree, is_lgbtq) %>% 
  count() %>% 
  pull(n)

likert_plot(
  my_var = interaction_agree, 
  title = 
    "\"The LGBTQ+ community at my school interacts with the LGBTQ+ community at other institutions\"",
  n = n
)

#satisfied
n <- 
  na_data %>% 
  drop_na(interaction_satisfaction, is_lgbtq) %>% 
  count() %>% 
  pull(n)

likert_plot(
  my_var = interaction_satisfaction, 
  title = 
    "\"I am satisfied with the degree to which the LGBTQ+ community at my school interacts with the LGBTQ+ community at other institutions\"",
  n = n
)
```

From the above plots, note that we put a black reference line at 50% in order to indicate that the majority of 
LGBTQ-identifying medical students both disagree with the statement that their local LGBTQ+ affinity 
organization interacts with the larger LGBTQ+ community *and* that they are not satisfied with the level of 
intercollegiate interaction that they do have.

**By school - each school is a point**

If we take each unique school and average the likert scale ratings, we can make box-and-whisker plots to summarize the data in a slightly different way. 

```{r, fig.width = 5}
var_labels <- 
  setNames(
    object = , 
      c(
        "\"The LGBTQ+ community at my school interacts with the LGBTQ+ community at other institutions\"" %>% 
          str_wrap(width = 50), 
        "\"I am satisfied with the degree to which the LGBTQ+ community at my school interacts with the LGBTQ+ community at other institutions\"" %>% 
          str_wrap(width = 50)
      ), 
    nm = c("agree", "satisfaction")
  )


na_data %>% 
  drop_na(Degree, is_lgbtq) %>% 
  group_by(school_attend, is_lgbtq) %>% 
  summarize_at(
    vars(starts_with("interaction_")), 
    mean, 
    na.rm = TRUE
  ) %>% 
  pivot_longer(
    cols = starts_with("interaction_"), 
    names_to = "variable", 
    values_to = "value", 
    names_prefix = "interaction_"
  ) %>% 
  ggplot(aes(x = is_lgbtq, y = value, fill = is_lgbtq)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.4, stroke = 0, color = "black") + 
  facet_wrap(vars(variable), labeller = labeller(variable = var_labels)) + 
  scale_y_continuous(minor_breaks = NULL) + 
  labs(
    subtitle = "", 
    x = NULL, 
    y = "Mean likert score across all respondents (1-5)", 
    fill = NULL
  )
  
```


### Perceived benefit from a national LGBTQ+ affinity organization for medical students

**Personal Benefit**

On an individual level...

```{r, fig.width = 8}
n <- 
  na_data %>% 
  drop_na(is_lgbtq, personal_benefit_mspa) %>% 
  count() %>% 
  pull(n)

likert_plot(
  my_var = personal_benefit_mspa, 
  title = "I would personally benefit from a national LGBTQ+ affinity organization", 
  n = n
)
```

**Community benefit:**

On an individual level...

```{r, fig.width = 8}
n <- 
  na_data %>% 
  drop_na(is_lgbtq, community_benefit_mspa) %>% 
  count() %>% 
  pull(n)

likert_plot(
  my_var = personal_benefit_mspa, 
  title = 
    "My community would  benefit from a national LGBTQ+ affinity organization", 
  n = n
)
```

### Which of your school's activities would be enhanced by a national LGBTQ+ medical student organization?

```{r}

```



